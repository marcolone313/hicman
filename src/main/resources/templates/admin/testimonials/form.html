<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Modifica Testimonianza' : 'Nuova Testimonianza'} + ' - Hicman Capital Partner'">
        Nuova Testimonianza - Hicman Capital Partner
    </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin-forms.css}">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <h3>Hicman Capital</h3>
                <small>Admin Panel</small>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin" class="admin-nav-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/blog" class="admin-nav-item">
                    <i class="bi bi-newspaper"></i>
                    <span>Rassegna Stampa</span>
                </a>
                <a href="/admin/testimonials" class="admin-nav-item active">
                    <i class="bi bi-chat-quote"></i>
                    <span>Dicono di Noi</span>
                </a>
                <a href="/" class="admin-nav-item" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>Visualizza Sito</span>
                </a>
                <form th:action="@{/admin/logout}" method="post">
                    <button type="submit" class="admin-nav-item logout-btn">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </form>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Header -->
            <header class="admin-header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                
                <div class="admin-header-title">
                    <h1 th:text="${isEdit ? 'Modifica Testimonianza' : 'Nuova Testimonianza'}">Nuova Testimonianza</h1>
                </div>
                
                <div class="admin-header-actions">
                    <a href="/admin/testimonials" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Torna alla lista
                    </a>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="admin-main">
                <!-- Success/Error Messages -->
                <div class="form-alert form-alert-success" th:if="${successMessage}">
                    <i class="bi bi-check-circle-fill"></i>
                    <span th:text="${successMessage}"></span>
                </div>

                <div class="form-alert form-alert-danger" th:if="${errorMessage}">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span th:text="${errorMessage}"></span>
                </div>

                <!-- Validation Errors -->
                <div class="form-alert form-alert-danger" th:if="${#fields.hasErrors('testimonial.*')}">
                    <div>
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Errori di validazione:</strong>
                        <ul>
                            <li th:each="err : ${#fields.errors('testimonial.*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                </div>

                <!-- Form Wrapper -->
                <div class="admin-form-wrapper">
                    <!-- Form Header -->
                    <div class="admin-form-header">
                        <h2>
                            <i class="bi bi-chat-quote"></i>
                            <span th:text="${isEdit ? 'Modifica Testimonianza' : 'Crea Nuova Testimonianza'}">Crea Nuova Testimonianza</span>
                        </h2>
                    </div>

                    <!-- Form Body -->
                    <div class="admin-form-body">
                        <form th:action="@{/admin/testimonials/save}" 
                              th:object="${testimonial}" 
                              method="post" 
                              enctype="multipart/form-data"
                              id="testimonialForm">
                            
                            <!-- Hidden ID for edit -->
                            <input type="hidden" th:field="*{id}">
                            
                            <!-- Content Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-quote"></i>
                                    Contenuto Testimonianza
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Inserisci il testo della testimonianza o citazione
                                </div>

                                <!-- Content -->
                                <div class="form-group">
                                    <label for="content" class="required">Testo Testimonianza</label>
                                    <textarea class="form-control" 
                                              id="content" 
                                              th:field="*{content}"
                                              rows="8"
                                              maxlength="1000"
                                              placeholder="Inserisci la testimonianza o citazione..."
                                              required
                                              oninput="updateCharCount(this, 'contentCounter')"></textarea>
                                    <div class="char-counter" id="contentCounter">0 / 1000 caratteri</div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Il testo apparirà come citazione nella pagina pubblica
                                    </div>
                                </div>
                            </div>

                            <!-- Source Information Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-person-badge"></i>
                                    Informazioni Fonte
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Dettagli sulla fonte della testimonianza
                                </div>

                                <div class="row">
                                    <!-- Source Name -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="source" class="required">Nome Fonte</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="source" 
                                                   th:field="*{source}"
                                                   placeholder="es. John Doe, Il Sole 24 Ore"
                                                   required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Nome della persona o testata giornalistica
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Source Role -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="sourceRole">Ruolo/Testata</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="sourceRole" 
                                                   th:field="*{sourceRole}"
                                                   placeholder="es. CEO, Giornalista economico">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Ruolo della persona o tipo di testata
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Source URL -->
                                <div class="form-group">
                                    <label for="sourceUrl">Link Fonte</label>
                                    <input type="url" 
                                           class="form-control" 
                                           id="sourceUrl" 
                                           th:field="*{sourceUrl}"
                                           placeholder="https://esempio.com/articolo">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Link alla pagina originale della testimonianza (opzionale)
                                    </div>
                                </div>
                            </div>

                            <!-- Publication Settings Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-calendar-event"></i>
                                    Impostazioni Pubblicazione
                                </h3>

                                <div class="row">
                                    <!-- Published Date -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="publishedDate">Data di Pubblicazione</label>
                                            <input type="datetime-local" 
                                                   class="form-control" 
                                                   id="publishedDate" 
                                                   th:field="*{publishedDate}">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Data e ora di pubblicazione della testimonianza
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Published Status -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Stato Pubblicazione</label>
                                            <div class="custom-switch">
                                                <div class="switch-input">
                                                    <input type="checkbox" 
                                                           id="published" 
                                                           th:field="*{published}">
                                                    <span class="switch-slider"></span>
                                                </div>
                                                <label for="published">
                                                    Pubblica immediatamente
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                La testimonianza sarà visibile pubblicamente solo se pubblicata
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button type="submit" name="action" value="save" class="btn btn-primary">
                                    <i class="bi bi-save"></i>
                                    Salva Testimonianza
                                </button>
                                
                                <button type="submit" name="action" value="save_and_publish" class="btn btn-success" th:if="${!isEdit || !testimonial.published}">
                                    <i class="bi bi-check-circle"></i>
                                    Salva e Pubblica
                                </button>
                                
                                <a href="/admin/testimonials" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i>
                                    Annulla
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
        }

        // Character counter
        function updateCharCount(textarea, counterId) {
            const counter = document.getElementById(counterId);
            const current = textarea.value.length;
            const max = textarea.maxLength;
            counter.textContent = `${current} / ${max} caratteri`;
            
            counter.classList.remove('warning', 'danger');
            if (current > max * 0.9) {
                counter.classList.add('warning');
            }
            if (current >= max) {
                counter.classList.add('danger');
            }
        }

        // Auto-hide alerts
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.form-alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() =>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Modifica Testimonianza' : 'Nuova Testimonianza'} + ' - Hicman Capital Partner'">
        Nuova Testimonianza - Hicman Capital Partner
    </title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-testimonials-form.css}">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <h3>Hicman Capital</h3>
                <small>Admin Panel</small>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin" class="admin-nav-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/blog" class="admin-nav-item">
                    <i class="bi bi-newspaper"></i>
                    <span>Rassegna Stampa</span>
                </a>
                <a href="/admin/testimonials" class="admin-nav-item active">
                    <i class="bi bi-chat-quote"></i>
                    <span>Dicono di Noi</span>
                </a>
                <a href="/" class="admin-nav-item" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>Visualizza Sito</span>
                </a>
                <form th:action="@{/admin/logout}" method="post">
                    <button type="submit" class="admin-nav-item logout-btn">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </form>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Header -->
            <header class="admin-header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                
                <div class="admin-header-title">
                    <h1 th:text="${isEdit ? 'Modifica Testimonianza' : 'Nuova Testimonianza'}">Nuova Testimonianza</h1>
                </div>
                
                <div class="admin-header-actions">
                    <a href="/admin/testimonials" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Torna alla lista
                    </a>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="admin-main">
                <!-- Success/Error Messages -->
                <div class="form-alert form-alert-success" th:if="${successMessage}">
                    <i class="bi bi-check-circle-fill"></i>
                    <span th:text="${successMessage}"></span>
                </div>

                <div class="form-alert form-alert-danger" th:if="${errorMessage}">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span th:text="${errorMessage}"></span>
                </div>

                <!-- Validation Errors -->
                <div class="form-alert form-alert-danger" th:if="${#fields.hasErrors('testimonial.*')}">
                    <div>
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Errori di validazione:</strong>
                        <ul>
                            <li th:each="err : ${#fields.errors('testimonial.*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                </div>

                <!-- Form Wrapper -->
                <div class="admin-form-wrapper">
                    <!-- Form Header -->
                    <div class="admin-form-header">
                        <h2>
                            <i class="bi bi-chat-quote"></i>
                            <span th:text="${isEdit ? 'Modifica Testimonianza' : 'Crea Nuova Testimonianza'}">Crea Nuova Testimonianza</span>
                        </h2>
                    </div>

                    <!-- Form Body -->
                    <div class="admin-form-body">
                        <form th:action="@{/admin/testimonials/save}" 
                              th:object="${testimonial}" 
                              method="post" 
                              enctype="multipart/form-data"
                              id="testimonialForm">
                            
                            <!-- Hidden ID for edit -->
                            <input type="hidden" th:field="*{id}">
                            
                            <!-- Quote Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-quote"></i>
                                    Contenuto Testimonianza
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Inserisci il testo della testimonianza o citazione
                                </div>

                                <!-- Quote -->
                                <div class="form-group">
                                    <label for="quote" class="required">Testo Testimonianza</label>
                                    <textarea class="form-control" 
                                              id="quote" 
                                              th:field="*{quote}"
                                              rows="8"
                                              maxlength="2000"
                                              placeholder="Inserisci la testimonianza o citazione..."
                                              required
                                              oninput="updateCharCount(this, 'quoteCounter')"></textarea>
                                    <div class="char-counter" id="quoteCounter">0 / 2000 caratteri</div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Il testo apparir√† come citazione nella pagina pubblica
                                    </div>
                                </div>
                            </div>

                            <!-- Source Information Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-person-badge"></i>
                                    Informazioni Fonte
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Dettagli sulla fonte della testimonianza
                                </div>

                                <div class="row">
                                    <!-- Source Name -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="sourceName" class="required">Nome Fonte</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="sourceName" 
                                                   th:field="*{sourceName}"
                                                   placeholder="es. John Doe, Il Sole 24 Ore"
                                                   required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Nome della persona o testata giornalistica
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Source Role -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="sourceRole">Ruolo/Testata</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="sourceRole" 
                                                   th:field="*{sourceRole}"
                                                   placeholder="es. CEO, Giornalista economico">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Ruolo della persona o tipo di testata
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- External Link -->
                                <div class="form-group">
                                    <label for="externalLink">Link Fonte</label>
                                    <input type="url" 
                                           class="form-control" 
                                           id="externalLink" 
                                           th:field="*{externalLink}"
                                           placeholder="https://esempio.com/articolo">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Link alla pagina originale della testimonianza (opzionale)
                                    </div>
                                </div>
                            </div>

                            <!-- Logo Upload Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-image"></i>
                                    Logo Fonte
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Carica il logo della fonte (opzionale)
                                </div>

                                <!-- Current Logo Display (if editing) -->
                                <div class="current-file" th:if="${testimonial.logoUrl != null}">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <div class="current-file-info">
                                        <div class="current-file-name">Logo attuale caricato</div>
                                        <div class="current-file-action">Carica un nuovo file per sostituirlo</div>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" 
                                               class="form-check-input" 
                                               id="removeLogo" 
                                               name="removeLogo" 
                                               value="true">
                                        <label class="form-check-label" for="removeLogo">
                                            Rimuovi logo
                                        </label>
                                    </div>
                                </div>

                                <!-- Logo Upload -->
                                <div class="form-group">
                                    <label for="logoFile">Carica Nuovo Logo</label>
                                    <div class="file-upload-wrapper" onclick="document.getElementById('logoFile').click()">
                                        <i class="bi bi-cloud-upload file-upload-icon"></i>
                                        <div class="file-upload-text">Clicca per caricare o trascina qui</div>
                                        <div class="file-upload-hint">Logo della fonte o testata giornalistica</div>
                                        <div class="file-upload-formats">Formati supportati: PNG, JPG, WEBP (max 10MB)</div>
                                        <input type="file" 
                                               class="form-control" 
                                               id="logoFile" 
                                               name="logoFile"
                                               accept="image/png,image/jpeg,image/jpg,image/webp"
                                               onchange="previewLogo(this)"
                                               style="display: none;">
                                    </div>
                                    
                                    <!-- Logo Preview -->
                                    <div class="file-preview" id="logoPreview" style="display: none;">
                                        <img id="logoPreviewImage" class="file-preview-image" alt="Preview">
                                        <div class="file-preview-info">
                                            <div class="file-preview-name" id="logoFileName"></div>
                                            <div class="file-preview-size" id="logoFileSize"></div>
                                        </div>
                                        <i class="bi bi-x-circle file-preview-remove" onclick="removeLogoPreview()"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Publication Settings Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-calendar-event"></i>
                                    Impostazioni Pubblicazione
                                </h3>

                                <div class="row">
                                    <!-- Published Date -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="publishedDate">Data di Pubblicazione</label>
                                            <input type="datetime-local" 
                                                   class="form-control" 
                                                   id="publishedDate" 
                                                   th:field="*{publishedDate}">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Data e ora di pubblicazione della testimonianza
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Published Status -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Stato Pubblicazione</label>
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                       class="form-check-input" 
                                                       id="published" 
                                                       th:field="*{published}">
                                                <label class="form-check-label" for="published">
                                                    Pubblica immediatamente
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Se spuntato, la testimonianza sar√† visibile sul sito
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <a href="/admin/testimonials" class="btn btn-secondary">
                                    <i class="bi bi-x-lg"></i>
                                    Annulla
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-lg"></i>
                                    <span th:text="${isEdit ? 'Aggiorna Testimonianza' : 'Crea Testimonianza'}">Crea Testimonianza</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script>
        // Character counter for textarea
        function updateCharCount(textarea, counterId) {
            const counter = document.getElementById(counterId);
            const current = textarea.value.length;
            const max = textarea.getAttribute('maxlength');
            counter.textContent = `${current} / ${max} caratteri`;
        }

        // Initialize character counters on page load
        document.addEventListener('DOMContentLoaded', function() {
            const quoteArea = document.getElementById('quote');
            if (quoteArea) {
                updateCharCount(quoteArea, 'quoteCounter');
            }
        });

        // Logo preview functionality
        function previewLogo(input) {
            const preview = document.getElementById('logoPreview');
            const previewImage = document.getElementById('logoPreviewImage');
            const fileName = document.getElementById('logoFileName');
            const fileSize = document.getElementById('logoFileSize');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Il file √® troppo grande. Dimensione massima: 10MB');
                    input.value = '';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    preview.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove logo preview
        function removeLogoPreview() {
            document.getElementById('logoFile').value = '';
            document.getElementById('logoPreview').style.display = 'none';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            sidebar.classList.toggle('show');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('adminSidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (window.innerWidth <= 992) {
                if (!sidebar.contains(event.target) && !toggle.contains(event.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>
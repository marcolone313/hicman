<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"></head>
<link rel="stylesheet" th:href="@{/css/admin.css}">
<body class="admin-body">

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside th:replace="~{admin/fragments/sidebar :: sidebar('testimonials')}"></aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Topbar -->
        <nav th:replace="~{admin/fragments/topbar :: topbar}"></nav>

        <!-- Content Area -->
        <div class="admin-content">
            <div class="container-fluid">
                
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h3 mb-1">
                                <i th:class="${isEdit} ? 'bi bi-pencil me-2' : 'bi bi-plus-circle me-2'"></i>
                                <span th:text="${isEdit} ? 'Modifica Testimonial' : 'Nuovo Testimonial'">
                                    Testimonial
                                </span>
                            </h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item">
                                        <a th:href="@{/admin}">Dashboard</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a th:href="@{/admin/testimonials}">Testimonial</a>
                                    </li>
                                    <li class="breadcrumb-item active" 
                                        th:text="${isEdit} ? 'Modifica' : 'Nuovo'">
                                        Nuovo
                                    </li>
                                </ol>
                            </nav>
                        </div>
                        <div class="col-auto">
                            <a th:href="@{/admin/testimonials}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Torna alla Lista
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Success Alert -->
                <div th:if="${successMessage}" 
                     class="alert alert-success alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Error Alert -->
                <div th:if="${errorMessage}" 
                     class="alert alert-danger alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Form -->
                <form th:action="@{/admin/testimonials/save}" 
                      th:object="${testimonial}" 
                      method="post"
                      id="testimonialForm">
                    
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{createdAt}">
                    <input type="hidden" th:field="*{displayOrder}">

                    <div class="row g-4">
                        <!-- Left Column - Main Content -->
                        <div class="col-lg-8">
                            
                            <!-- Author Info -->
                            <div class="admin-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-person me-2"></i>
                                        Informazioni Autore
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <!-- Author Name -->
                                        <div class="col-md-6">
                                            <label for="author" class="form-label">
                                                Nome Autore <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="author"
                                                   th:field="*{author}"
                                                   th:classappend="${#fields.hasErrors('author')} ? 'is-invalid'"
                                                   placeholder="es. Mario Rossi"
                                                   required
                                                   maxlength="100">
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('author')}" 
                                                 th:errors="*{author}">
                                                Errore nome
                                            </div>
                                        </div>

                                        <!-- Author Role -->
                                        <div class="col-md-6">
                                            <label for="authorRole" class="form-label">
                                                Ruolo/Posizione (opzionale)
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="authorRole"
                                                   th:field="*{authorRole}"
                                                   placeholder="es. CEO, CFO, Manager"
                                                   maxlength="100">
                                            <small class="form-text text-muted d-block mt-1">
                                                Posizione lavorativa dell'autore
                                            </small>
                                        </div>

                                        <!-- Company Name -->
                                        <div class="col-12">
                                            <label for="companyName" class="form-label">
                                                <i class="bi bi-building me-1"></i>
                                                Nome Azienda (opzionale)
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="companyName"
                                                   th:field="*{companyName}"
                                                   placeholder="es. Acme Corporation"
                                                   maxlength="100">
                                            <small class="form-text text-muted d-block mt-1">
                                                Azienda di appartenenza dell'autore
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Testimonial Content -->
                            <div class="admin-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-chat-quote me-2"></i>
                                        Contenuto Testimonial
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="content" class="form-label">
                                            Testo <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" 
                                                  id="content"
                                                  th:field="*{content}"
                                                  th:classappend="${#fields.hasErrors('content')} ? 'is-invalid'"
                                                  rows="8"
                                                  placeholder="Inserisci il contenuto della testimonianza..."
                                                  required
                                                  maxlength="1000"></textarea>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('content')}" 
                                             th:errors="*{content}">
                                            Errore contenuto
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small class="form-text text-muted">
                                                Massimo 1000 caratteri
                                            </small>
                                            <small class="form-text text-muted">
                                                <span id="contentCount">0</span>/1000 caratteri
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Source URL -->
                                    <div class="mb-0">
                                        <label for="sourceUrl" class="form-label">
                                            <i class="bi bi-link-45deg me-1"></i>
                                            URL Fonte (opzionale)
                                        </label>
                                        <input type="url" 
                                               class="form-control" 
                                               id="sourceUrl"
                                               th:field="*{sourceUrl}"
                                               placeholder="https://esempio.com/recensione"
                                               maxlength="500">
                                        <small class="form-text text-muted d-block mt-1">
                                            Link alla recensione originale o alla pagina di riferimento
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Preview Card -->
                            <div class="admin-card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-eye me-2"></i>
                                        Anteprima
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="testimonial-preview">
                                        <div class="quote-icon-preview mb-3">
                                            <i class="bi bi-quote display-4 text-primary opacity-25"></i>
                                        </div>
                                        <p class="preview-content mb-4" id="previewContent">
                                            Il contenuto apparirà qui...
                                        </p>
                                        <div class="preview-author">
                                            <h6 class="mb-0 fw-bold text-primary" id="previewAuthor">
                                                Nome Autore
                                            </h6>
                                            <p class="text-muted small mb-0" id="previewRole">
                                                Ruolo at Azienda
                                            </p>
                                            <div class="mt-2" id="previewLink" style="display: none;">
                                                <a href="#" class="btn btn-sm btn-outline-secondary" target="_blank">
                                                    <i class="bi bi-link-45deg me-1"></i>
                                                    Fonte
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Right Column - Actions & Info -->
                        <div class="col-lg-4">
                            
                            <!-- Publish Actions -->
                            <div class="admin-card mb-4 sticky-top" style="top: calc(var(--navbar-height) + 20px);">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-send me-2"></i>
                                        Pubblicazione
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Current Status -->
                                    <div class="mb-3">
                                        <label class="form-label">Stato attuale:</label>
                                        <div>
                                            <span th:if="${testimonial.published}" class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Pubblicato
                                            </span>
                                            <span th:unless="${testimonial.published}" class="badge bg-warning text-dark">
                                                <i class="bi bi-pencil me-1"></i>
                                                Bozza
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Display Order -->
                                    <div th:if="${testimonial.displayOrder != null && testimonial.displayOrder > 0}" class="mb-3">
                                        <label class="form-label">Posizione visualizzazione:</label>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-hash me-1"></i>
                                            Posizione <strong th:text="${testimonial.displayOrder}">1</strong>
                                        </p>
                                        <small class="text-muted">
                                            L'ordine può essere modificato dalla lista
                                        </small>
                                    </div>

                                    <!-- Created Date -->
                                    <div th:if="${testimonial.createdAt != null}" class="mb-3">
                                        <label class="form-label">Data creazione:</label>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-calendar3 me-1"></i>
                                            <span th:text="${#temporals.format(testimonial.createdAt, 'dd/MM/yyyy HH:mm')}">
                                                Data
                                            </span>
                                        </p>
                                    </div>

                                    <hr>

                                    <!-- Action Buttons -->
                                    <div class="d-grid gap-2">
                                        <!-- Save as Draft -->
                                        <button type="submit" 
                                                name="publish" 
                                                value="false"
                                                class="btn btn-outline-secondary">
                                            <i class="bi bi-save me-2"></i>
                                            Salva come Bozza
                                        </button>

                                        <!-- Publish -->
                                        <button type="submit" 
                                                name="publish" 
                                                value="true"
                                                class="btn btn-success">
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span th:text="${testimonial.published} ? 'Aggiorna e Mantieni Pubblicato' : 'Pubblica'">
                                                Pubblica
                                            </span>
                                        </button>

                                        <!-- Delete -->
                                        <button th:if="${isEdit}" 
                                                type="button" 
                                                class="btn btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal">
                                            <i class="bi bi-trash me-2"></i>
                                            Elimina Testimonial
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Help Card -->
                            <div class="admin-card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-lightbulb me-2"></i>
                                        Suggerimenti
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled small mb-0">
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Usa testimonianze autentiche e verificate
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Includi nome, ruolo e azienda per credibilità
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Mantieni il testo conciso (max 1000 caratteri)
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Aggiungi link alla fonte quando disponibile
                                        </li>
                                        <li class="mb-0">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Usa l'anteprima per verificare il risultato
                                        </li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>

            </div>
        </div>
    </main>
</div>

<!-- Delete Confirmation Modal -->
<div th:if="${isEdit}" class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare questo testimonial?</p>
                <p class="mb-0">
                    <strong th:text="${testimonial.author}">Autore</strong>
                    <span th:if="${testimonial.companyName}" class="text-muted">
                        - <span th:text="${testimonial.companyName}">Azienda</span>
                    </span>
                </p>
                <div class="alert alert-warning mt-3 mb-0">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        Questa azione non può essere annullata.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    Annulla
                </button>
                <form th:action="@{/admin/testimonials/delete/{id}(id=${testimonial.id})}" method="post">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Elimina Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const form = document.getElementById('testimonialForm');
    const authorInput = document.getElementById('author');
    const roleInput = document.getElementById('authorRole');
    const companyInput = document.getElementById('companyName');
    const contentInput = document.getElementById('content');
    const sourceUrlInput = document.getElementById('sourceUrl');
    
    // Preview elements
    const previewAuthor = document.getElementById('previewAuthor');
    const previewRole = document.getElementById('previewRole');
    const previewContent = document.getElementById('previewContent');
    const previewLink = document.getElementById('previewLink');
    const contentCount = document.getElementById('contentCount');

    // Update character counter
    function updateContentCount() {
        const count = contentInput.value.length;
        contentCount.textContent = count;
        
        if (count > 900) {
            contentCount.parentElement.classList.add('text-danger');
            contentCount.parentElement.classList.remove('text-muted');
        } else {
            contentCount.parentElement.classList.remove('text-danger');
            contentCount.parentElement.classList.add('text-muted');
        }
    }

    // Update preview
    function updatePreview() {
        // Update author name
        const author = authorInput.value.trim() || 'Nome Autore';
        previewAuthor.textContent = author;
        
        // Update role and company
        const role = roleInput.value.trim();
        const company = companyInput.value.trim();
        
        if (role && company) {
            previewRole.textContent = role + ' at ' + company;
            previewRole.style.display = 'block';
        } else if (role) {
            previewRole.textContent = role;
            previewRole.style.display = 'block';
        } else if (company) {
            previewRole.textContent = company;
            previewRole.style.display = 'block';
        } else {
            previewRole.textContent = 'Ruolo at Azienda';
            previewRole.style.display = 'block';
        }
        
        // Update content
        const content = contentInput.value.trim() || 'Il contenuto apparirà qui...';
        previewContent.textContent = content;
        
        // Update source link
        const sourceUrl = sourceUrlInput.value.trim();
        if (sourceUrl) {
            previewLink.style.display = 'block';
            previewLink.querySelector('a').href = sourceUrl;
        } else {
            previewLink.style.display = 'none';
        }
    }

    // Event listeners
    if (contentInput) {
        contentInput.addEventListener('input', function() {
            updateContentCount();
            updatePreview();
        });
        updateContentCount();
    }

    if (authorInput) {
        authorInput.addEventListener('input', updatePreview);
    }

    if (roleInput) {
        roleInput.addEventListener('input', updatePreview);
    }

    if (companyInput) {
        companyInput.addEventListener('input', updatePreview);
    }

    if (sourceUrlInput) {
        sourceUrlInput.addEventListener('input', updatePreview);
    }

    // Initialize preview
    updatePreview();

    // Form validation
    if (form) {
        form.addEventListener('submit', function(e) {
            const author = authorInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!author || !content) {
                e.preventDefault();
                alert('Nome autore e contenuto sono obbligatori!');
                return false;
            }
            
            if (content.length < 10) {
                e.preventDefault();
                alert('Il contenuto deve contenere almeno 10 caratteri!');
                return false;
            }
        });
    }

    // Warn before leaving with unsaved changes
    let formChanged = false;
    const formInputs = form.querySelectorAll('input, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    form.addEventListener('submit', function() {
        formChanged = false;
    });

    // Auto-hide alerts
    const alerts = document.querySelectorAll('.alert:not(.alert-warning)');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
});
</script>

<style>
/* Testimonial Preview Styles */
.testimonial-preview {
    background: var(--bg-light);
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 2rem;
}

.quote-icon-preview {
    line-height: 1;
}

.preview-content {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-dark);
    font-style: italic;
    min-height: 60px;
}

.preview-author {
    padding-top: 1rem;
    border-top: 2px solid #e0e0e0;
}

.preview-author h6 {
    font-size: 1.1rem;
}

.preview-author p {
    font-size: 0.9rem;
}

/* Character counter colors */
.text-danger {
    font-weight: 600;
}
</style>

</body>
</html>
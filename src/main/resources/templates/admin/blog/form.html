<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Modifica Articolo' : 'Nuovo Articolo'} + ' - Hicman Capital Partner'">
        Nuovo Articolo - Hicman Capital Partner
    </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin-forms.css}">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <h3>Hicman Capital</h3>
                <small>Admin Panel</small>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin" class="admin-nav-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/blog" class="admin-nav-item active">
                    <i class="bi bi-newspaper"></i>
                    <span>Rassegna Stampa</span>
                </a>
                <a href="/admin/testimonials" class="admin-nav-item">
                    <i class="bi bi-chat-quote"></i>
                    <span>Dicono di Noi</span>
                </a>
                <a href="/" class="admin-nav-item" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>Visualizza Sito</span>
                </a>
                <form th:action="@{/admin/logout}" method="post">
                    <button type="submit" class="admin-nav-item logout-btn">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </form>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Header -->
            <header class="admin-header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                
                <div class="admin-header-title">
                    <h1 th:text="${isEdit ? 'Modifica Articolo' : 'Nuovo Articolo'}">Nuovo Articolo</h1>
                </div>
                
                <div class="admin-header-actions">
                    <a href="/admin/blog" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Torna alla lista
                    </a>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="admin-main">
                <!-- Success/Error Messages -->
                <div class="form-alert form-alert-success" th:if="${successMessage}">
                    <i class="bi bi-check-circle-fill"></i>
                    <span th:text="${successMessage}"></span>
                </div>

                <div class="form-alert form-alert-danger" th:if="${errorMessage}">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span th:text="${errorMessage}"></span>
                </div>

                <!-- Validation Errors -->
                <div class="form-alert form-alert-danger" th:if="${#fields.hasErrors('post.*')}">
                    <div>
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Errori di validazione:</strong>
                        <ul>
                            <li th:each="err : ${#fields.errors('post.*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                </div>

                <!-- Form Wrapper -->
                <div class="admin-form-wrapper">
                    <!-- Form Header -->
                    <div class="admin-form-header">
                        <h2>
                            <i class="bi bi-newspaper"></i>
                            <span th:text="${isEdit ? 'Modifica Articolo' : 'Crea Nuovo Articolo'}">Crea Nuovo Articolo</span>
                        </h2>
                    </div>

                    <!-- Form Body -->
                    <div class="admin-form-body">
                        <form th:action="@{/admin/blog/save}" 
                              th:object="${post}" 
                              method="post" 
                              enctype="multipart/form-data"
                              id="blogForm">
                            
                            <!-- Hidden ID for edit -->
                            <input type="hidden" th:field="*{id}">
                            
                            <!-- Main Information Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-file-text"></i>
                                    Informazioni Principali
                                </h3>

                                <div class="form-section-description">
                                    <i class="bi bi-info-circle"></i>
                                    Compila i campi principali dell'articolo della rassegna stampa
                                </div>

                                <!-- Title -->
                                <div class="form-group">
                                    <label for="title" class="required">Titolo Articolo</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="title" 
                                           th:field="*{title}"
                                           placeholder="Inserisci il titolo dell'articolo"
                                           required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i>
                                        Il titolo apparirà come intestazione dell'articolo
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="form-group">
                                    <label for="content" class="required">Contenuto Articolo</label>
                                    <textarea class="form-control" 
                                              id="content" 
                                              th:field="*{content}"
                                              rows="15"
                                              maxlength="10000"
                                              placeholder="Inserisci il contenuto completo dell'articolo..."
                                              required
                                              oninput="updateCharCount(this, 'contentCounter')"></textarea>
                                    <div class="char-counter" id="contentCounter">0 / 10000 caratteri</div>
                                </div>
                            </div>

                            <!-- Source Information Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-link-45deg"></i>
                                    Fonte e Collegamenti
                                </h3>

                                <div class="row">
                                    <!-- Source Name -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="sourceName">Nome Fonte</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="sourceName" 
                                                   th:field="*{sourceName}"
                                                   placeholder="es. Il Sole 24 Ore, Bloomberg, etc.">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Nome della testata o fonte dell'articolo
                                            </div>
                                        </div>
                                    </div>

                                    <!-- External Link -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="externalLink">Link Esterno</label>
                                            <input type="url" 
                                                   class="form-control" 
                                                   id="externalLink" 
                                                   th:field="*{externalLink}"
                                                   placeholder="https://esempio.com/articolo">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Link alla pagina originale dell'articolo
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Media Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-image"></i>
                                    Immagine di Copertina
                                </h3>

                                <!-- Current Image (if editing) -->
                                <div class="form-group" th:if="${isEdit && post.imageUrl != null}">
                                    <label>Immagine Attuale</label>
                                    <div class="file-preview">
                                        <img th:src="${post.imageUrl}" 
                                             alt="Immagine attuale" 
                                             class="file-preview-image">
                                        <div class="file-preview-info">
                                            <div class="file-preview-name">Immagine caricata</div>
                                        </div>
                                        <label>
                                            <input type="checkbox" 
                                                   name="removeImage" 
                                                   value="true">
                                            Rimuovi immagine
                                        </label>
                                    </div>
                                </div>

                                <!-- Upload New Image -->
                                <div class="form-group">
                                    <label for="imageFile">
                                        <span th:text="${isEdit && post.imageUrl != null ? 'Carica Nuova Immagine' : 'Carica Immagine'}">
                                            Carica Immagine
                                        </span>
                                    </label>
                                    <div class="file-upload-wrapper">
                                        <div class="file-upload-icon">
                                            <i class="bi bi-cloud-upload"></i>
                                        </div>
                                        <div class="file-upload-text">
                                            Trascina un'immagine qui o clicca per selezionare
                                        </div>
                                        <div class="file-upload-hint">
                                            Dimensione massima: 10MB
                                        </div>
                                        <div class="file-upload-formats">
                                            Formati supportati: JPG, PNG, WEBP, GIF
                                        </div>
                                        <input type="file" 
                                               id="imageFile" 
                                               name="imageFile" 
                                               accept="image/jpeg,image/png,image/webp,image/gif"
                                               onchange="previewImage(this)">
                                    </div>
                                    
                                    <!-- Preview -->
                                    <div id="imagePreview" class="file-preview d-none">
                                        <img id="previewImg" class="file-preview-image" src="" alt="Preview">
                                        <div class="file-preview-info">
                                            <div class="file-preview-name" id="fileName"></div>
                                            <div class="file-preview-size" id="fileSize"></div>
                                        </div>
                                        <i class="bi bi-x-circle file-preview-remove" onclick="removeImagePreview()"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Publication Settings Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-calendar-event"></i>
                                    Impostazioni Pubblicazione
                                </h3>

                                <div class="row">
                                    <!-- Published Date -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="publishedDate">Data di Pubblicazione</label>
                                            <input type="datetime-local" 
                                                   class="form-control" 
                                                   id="publishedDate" 
                                                   th:field="*{publishedDate}">
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Data e ora di pubblicazione dell'articolo
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Published Status -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Stato Pubblicazione</label>

                                            <!-- hidden per false quando non spuntato -->
                                            <input type="hidden" name="published" value="false"/>

                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       id="published"
                                                       name="published"
                                                       value="true"
                                                       th:checked="*{published}">
                                                <label class="form-check-label" for="published">
                                                    Pubblica immediatamente
                                                </label>
                                            </div>

                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                L'articolo sarà visibile pubblicamente solo se pubblicato
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button type="submit" name="action" value="save" class="btn btn-primary">
                                    <i class="bi bi-save"></i>
                                    Salva Articolo
                                </button>
                                
                                <button type="submit"
                                        name="action"
                                        value="save_and_publish"
                                        class="btn btn-success"
                                        th:if="${!isEdit || !post.published}">
                                    <i class="bi bi-check-circle"></i>
                                    Salva e Pubblica
                                </button>
                                
                                <a href="/admin/blog" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i>
                                    Annulla
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
        }

        // Character counter
        function updateCharCount(textarea, counterId) {
            const counter = document.getElementById(counterId);
            const current = textarea.value.length;
            const max = textarea.maxLength;
            counter.textContent = `${current} / ${max} caratteri`;
            
            counter.classList.remove('warning', 'danger');
            if (current > max * 0.9) {
                counter.classList.add('warning');
            }
            if (current >= max) {
                counter.classList.add('danger');
            }
        }

        // Image preview
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileSize').textContent = 
                        (file.size / 1024 / 1024).toFixed(2) + ' MB';
                    document.getElementById('imagePreview').classList.remove('d-none');
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removeImagePreview() {
            document.getElementById('imageFile').value = '';
            document.getElementById('imagePreview').classList.add('d-none');
        }

        // Auto-hide alerts
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.form-alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
            
            // Initialize char counter if content exists
            const contentField = document.getElementById('content');
            if (contentField && contentField.value) {
                updateCharCount(contentField, 'contentCounter');
            }
        });

        // Form loading state
        document.getElementById('blogForm').addEventListener('submit', function() {
            const submitButtons = this.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(btn => {
                btn.classList.add('loading');
                btn.disabled = true;
            });
        });
    </script>
</body>
</html>

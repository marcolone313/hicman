<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"></head>
<link rel="stylesheet" th:href="@{/css/admin.css}">
<body class="admin-body">

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside th:replace="~{admin/fragments/sidebar :: sidebar('blog')}"></aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Topbar -->
        <nav th:replace="~{admin/fragments/topbar :: topbar}"></nav>

        <!-- Content Area -->
        <div class="admin-content">
            <div class="container-fluid">
                
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h3 mb-1">
                                <i th:class="${isEdit} ? 'bi bi-pencil me-2' : 'bi bi-plus-circle me-2'"></i>
                                <span th:text="${isEdit} ? 'Modifica Post' : 'Nuovo Post'">Post</span>
                            </h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item">
                                        <a th:href="@{/admin}">Dashboard</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a th:href="@{/admin/blog}">Blog</a>
                                    </li>
                                    <li class="breadcrumb-item active" 
                                        th:text="${isEdit} ? 'Modifica' : 'Nuovo'">
                                        Nuovo
                                    </li>
                                </ol>
                            </nav>
                        </div>
                        <div class="col-auto">
                            <a th:href="@{/admin/blog}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Torna alla Lista
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Success Alert -->
                <div th:if="${successMessage}" 
                     class="alert alert-success alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Error Alert -->
                <div th:if="${errorMessage}" 
                     class="alert alert-danger alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Form -->
                <form th:action="@{/admin/blog/save}" 
                      th:object="${post}" 
                      method="post" 
                      enctype="multipart/form-data"
                      id="postForm">
                    
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{imageUrl}">
                    <input type="hidden" th:field="*{createdAt}">
                    <input type="hidden" th:field="*{publishedDate}">

                    <div class="row g-4">
                        <!-- Left Column - Main Content -->
                        <div class="col-lg-8">
                            
                            <!-- Title -->
                            <div class="admin-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-text-left me-2"></i>
                                        Informazioni Principali
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">
                                            Titolo <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" 
                                               class="form-control form-control-lg" 
                                               id="title"
                                               th:field="*{title}"
                                               th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'"
                                               placeholder="Inserisci il titolo del post"
                                               required
                                               maxlength="200">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" 
                                             th:errors="*{title}">
                                            Errore titolo
                                        </div>
                                        <small class="form-text text-muted">
                                            <span id="titleCount">0</span>/200 caratteri
                                        </small>
                                    </div>

                                    <!-- Content -->
                                    <div class="mb-3">
                                        <label for="content" class="form-label">
                                            Contenuto <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" 
                                                  id="content"
                                                  th:field="*{content}"
                                                  th:classappend="${#fields.hasErrors('content')} ? 'is-invalid'"
                                                  rows="15"
                                                  placeholder="Scrivi il contenuto del post..."
                                                  required></textarea>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('content')}" 
                                             th:errors="*{content}">
                                            Errore contenuto
                                        </div>
                                        <small class="form-text text-muted">
                                            Supporta HTML base: &lt;p&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;a&gt;
                                        </small>
                                    </div>

                                    <!-- External Link -->
                                    <div class="mb-0">
                                        <label for="externalLink" class="form-label">
                                            <i class="bi bi-link-45deg me-1"></i>
                                            Link Esterno (opzionale)
                                        </label>
                                        <input type="url" 
                                               class="form-control" 
                                               id="externalLink"
                                               th:field="*{externalLink}"
                                               placeholder="https://esempio.com/articolo"
                                               maxlength="500">
                                        <small class="form-text text-muted">
                                            URL dell'articolo originale completo
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Upload -->
                            <div class="admin-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-image me-2"></i>
                                        Immagine in Evidenza
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Current Image Preview -->
                                    <div th:if="${post.hasImage()}" class="mb-3" id="currentImagePreview">
                                        <label class="form-label">Immagine attuale:</label>
                                        <div class="position-relative d-inline-block">
                                            <img th:src="${post.imageUrl}" 
                                                 alt="Current image" 
                                                 class="img-thumbnail"
                                                 style="max-width: 300px; max-height: 200px;">
                                            <button type="button" 
                                                    class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                                                    onclick="removeCurrentImage()"
                                                    title="Rimuovi immagine">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- File Upload -->
                                    <div class="mb-3">
                                        <label for="imageFile" class="form-label">
                                            <span th:text="${post.hasImage()} ? 'Sostituisci immagine' : 'Carica immagine'">
                                                Carica immagine
                                            </span>
                                        </label>
                                        <input type="file" 
                                               class="form-control" 
                                               id="imageFile"
                                               name="imageFile"
                                               accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                               onchange="previewImage(event)">
                                        <small class="form-text text-muted">
                                            Formati supportati: JPG, PNG, GIF, WEBP. Max 10MB.
                                        </small>
                                    </div>

                                    <!-- New Image Preview -->
                                    <div id="newImagePreview" style="display: none;" class="mt-3">
                                        <label class="form-label">Anteprima nuova immagine:</label>
                                        <div class="position-relative d-inline-block">
                                            <img id="previewImg" 
                                                 src="" 
                                                 alt="Preview" 
                                                 class="img-thumbnail"
                                                 style="max-width: 300px; max-height: 200px;">
                                            <button type="button" 
                                                    class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                                                    onclick="clearImagePreview()"
                                                    title="Rimuovi">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Right Column - Metadata & Actions -->
                        <div class="col-lg-4">
                            
                            <!-- Publish Actions -->
                            <div class="admin-card mb-4 sticky-top" style="top: calc(var(--navbar-height) + 20px);">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-send me-2"></i>
                                        Pubblicazione
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Status -->
                                    <div class="mb-3">
                                        <label class="form-label">Stato attuale:</label>
                                        <div>
                                            <span th:if="${post.published}" class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Pubblicato
                                            </span>
                                            <span th:unless="${post.published}" class="badge bg-warning text-dark">
                                                <i class="bi bi-pencil me-1"></i>
                                                Bozza
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Published Date Info -->
                                    <div th:if="${post.publishedDate != null}" class="mb-3">
                                        <label class="form-label">Data pubblicazione:</label>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-calendar3 me-1"></i>
                                            <span th:text="${#temporals.format(post.publishedDate, 'dd/MM/yyyy HH:mm')}">
                                                Data
                                            </span>
                                        </p>
                                    </div>

                                    <!-- Last Updated -->
                                    <div th:if="${post.updatedAt != null}" class="mb-3">
                                        <label class="form-label">Ultimo aggiornamento:</label>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-clock me-1"></i>
                                            <span th:text="${#temporals.format(post.updatedAt, 'dd/MM/yyyy HH:mm')}">
                                                Data
                                            </span>
                                        </p>
                                    </div>

                                    <hr>

                                    <!-- Action Buttons -->
                                    <div class="d-grid gap-2">
                                        <!-- Save as Draft -->
                                        <button type="submit" 
                                                name="publish" 
                                                value="false"
                                                class="btn btn-outline-secondary">
                                            <i class="bi bi-save me-2"></i>
                                            Salva come Bozza
                                        </button>

                                        <!-- Publish -->
                                        <button type="submit" 
                                                name="publish" 
                                                value="true"
                                                class="btn btn-success">
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span th:text="${post.published} ? 'Aggiorna e Mantieni Pubblicato' : 'Pubblica'">
                                                Pubblica
                                            </span>
                                        </button>

                                        <!-- Preview -->
                                        <a th:if="${isEdit}" 
                                           th:href="@{/admin/blog/preview/{id}(id=${post.id})}" 
                                           class="btn btn-outline-info"
                                           target="_blank">
                                            <i class="bi bi-eye me-2"></i>
                                            Anteprima
                                        </a>

                                        <!-- Delete -->
                                        <button th:if="${isEdit}" 
                                                type="button" 
                                                class="btn btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal">
                                            <i class="bi bi-trash me-2"></i>
                                            Elimina Post
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Source Info -->
                            <div class="admin-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-newspaper me-2"></i>
                                        Fonte
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-0">
                                        <label for="sourceName" class="form-label">
                                            Nome della fonte (opzionale)
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="sourceName"
                                               th:field="*{sourceName}"
                                               placeholder="es. Il Sole 24 Ore"
                                               maxlength="100">
                                        <small class="form-text text-muted">
                                            Nome della testata o fonte dell'articolo
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO Tips -->
                            <div class="admin-card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-lightbulb me-2"></i>
                                        Suggerimenti
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled small mb-0">
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Usa un titolo chiaro e descrittivo
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Aggiungi un'immagine in evidenza
                                        </li>
                                        <li class="mb-2">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Specifica la fonte se disponibile
                                        </li>
                                        <li class="mb-0">
                                            <i class="bi bi-check text-success me-1"></i>
                                            Includi link esterno all'articolo completo
                                        </li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>

            </div>
        </div>
    </main>
</div>

<!-- Delete Confirmation Modal -->
<div th:if="${isEdit}" class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare questo post?</p>
                <p class="mb-0"><strong th:text="${post.title}">Titolo</strong></p>
                <div class="alert alert-warning mt-3 mb-0">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        Questa azione non può essere annullata.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annulla
                </button>
                <form th:action="@{/admin/blog/delete/{id}(id=${post.id})}" method="post">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Title character counter
    const titleInput = document.getElementById('title');
    const titleCount = document.getElementById('titleCount');
    
    if (titleInput && titleCount) {
        function updateTitleCount() {
            titleCount.textContent = titleInput.value.length;
        }
        
        titleInput.addEventListener('input', updateTitleCount);
        updateTitleCount(); // Initialize
    }

    // Form validation
    const form = document.getElementById('postForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const title = titleInput.value.trim();
            const content = document.getElementById('content').value.trim();
            
            if (!title || !content) {
                e.preventDefault();
                alert('Titolo e contenuto sono obbligatori!');
                return false;
            }
        });
    }

    // Auto-hide alerts
    const alerts = document.querySelectorAll('.alert:not(.alert-warning)');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });

    // Warn before leaving with unsaved changes
    let formChanged = false;
    const formInputs = form.querySelectorAll('input, textarea, select');
    
    formInputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    form.addEventListener('submit', function() {
        formChanged = false;
    });
});

// Image preview functionality
function previewImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('newImagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (file) {
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('Il file è troppo grande. Dimensione massima: 10MB');
            event.target.value = '';
            return;
        }
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Formato file non valido. Usa JPG, PNG, GIF o WEBP.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function clearImagePreview() {
    document.getElementById('imageFile').value = '';
    document.getElementById('newImagePreview').style.display = 'none';
    document.getElementById('previewImg').src = '';
}

function removeCurrentImage() {
    if (confirm('Rimuovere l\'immagine attuale? Questa operazione sarà definitiva dopo il salvataggio.')) {
        document.getElementById('currentImagePreview').style.display = 'none';
        // Set a hidden field to mark image for deletion
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'removeImage';
        input.value = 'true';
        document.getElementById('postForm').appendChild(input);
    }
}
</script>

</body>
</html>
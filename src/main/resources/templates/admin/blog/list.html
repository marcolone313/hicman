<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}"></head>
<link rel="stylesheet" th:href="@{/css/admin.css}">
<body class="admin-body">

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside th:replace="~{admin/fragments/sidebar :: sidebar('blog')}"></aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Topbar -->
        <nav th:replace="~{admin/fragments/topbar :: topbar}"></nav>

        <!-- Content Area -->
        <div class="admin-content">
            <div class="container-fluid">
                
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h3 mb-1">
                                <i class="bi bi-file-text me-2"></i>
                                Gestione Blog
                            </h1>
                            <p class="text-muted mb-0">Gestisci tutti i post della rassegna stampa</p>
                        </div>
                        <div class="col-auto">
                            <a th:href="@{/admin/blog/new}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>
                                Nuovo Post
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Success Alert -->
                <div th:if="${successMessage}" 
                     class="alert alert-success alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Error Alert -->
                <div th:if="${errorMessage}" 
                     class="alert alert-danger alert-dismissible fade show" 
                     role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Stats Summary -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="stats-mini-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-mini-icon bg-primary">
                                    <i class="bi bi-file-text"></i>
                                </div>
                                <div class="ms-3">
                                    <h4 class="mb-0" th:text="${totalItems}">0</h4>
                                    <small class="text-muted">Totale Post</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-mini-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-mini-icon bg-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="ms-3">
                                    <h4 class="mb-0" th:text="${publishedCount ?: 0}">0</h4>
                                    <small class="text-muted">Pubblicati</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-mini-card">
                            <div class="d-flex align-items-center">
                                <div class="stats-mini-icon bg-warning">
                                    <i class="bi bi-pencil"></i>
                                </div>
                                <div class="ms-3">
                                    <h4 class="mb-0" th:text="${draftCount ?: 0}">0</h4>
                                    <small class="text-muted">Bozze</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters and Search -->
                <div class="admin-card mb-4">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <!-- Status Filter -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-2">
                                    <i class="bi bi-funnel me-1"></i>
                                    Filtra per stato
                                </label>
                                <div class="btn-group w-100" role="group">
                                    <a th:href="@{/admin/blog}" 
                                       class="btn btn-outline-secondary"
                                       th:classappend="${status == null} ? 'active' : ''">
                                        <i class="bi bi-collection me-1"></i>
                                        Tutti
                                    </a>
                                    <a th:href="@{/admin/blog(status='published')}" 
                                       class="btn btn-outline-secondary"
                                       th:classappend="${status == 'published'} ? 'active' : ''">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Pubblicati
                                    </a>
                                    <a th:href="@{/admin/blog(status='draft')}" 
                                       class="btn btn-outline-secondary"
                                       th:classappend="${status == 'draft'} ? 'active' : ''">
                                        <i class="bi bi-pencil me-1"></i>
                                        Bozze
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-2">
                                    <i class="bi bi-search me-1"></i>
                                    Cerca
                                </label>
                                <form th:action="@{/admin/blog}" method="get" class="d-flex gap-2">
                                    <input type="hidden" name="status" th:value="${status}">
                                    <input type="text" 
                                           class="form-control" 
                                           name="search" 
                                           th:value="${search}"
                                           placeholder="Cerca per titolo, contenuto o fonte...">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    <a th:if="${search}" 
                                       th:href="@{/admin/blog(status=${status})}" 
                                       class="btn btn-outline-secondary"
                                       title="Cancella ricerca">
                                        <i class="bi bi-x-lg"></i>
                                    </a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posts Table -->
                <div class="admin-card">
                    <!-- Empty State -->
                    <div th:if="${#lists.isEmpty(posts)}" class="card-body text-center py-5">
                        <div class="empty-state">
                            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                            <h5 class="mb-2">Nessun post trovato</h5>
                            <p class="text-muted mb-4">
                                <span th:if="${search}">
                                    Nessun risultato per "<span th:text="${search}"></span>"
                                </span>
                                <span th:unless="${search}">
                                    Crea il tuo primo post per iniziare
                                </span>
                            </p>
                            <a th:href="@{/admin/blog/new}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>
                                Crea Nuovo Post
                            </a>
                        </div>
                    </div>

                    <!-- Table Content -->
                    <div th:unless="${#lists.isEmpty(posts)}" class="table-container">
                        <!-- Bulk Actions Bar -->
                        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                                <div>
                                    <span class="fw-semibold me-2">
                                        <span id="selectedCount">0</span> selezionati
                                    </span>
                                </div>
                                <div>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger" 
                                            id="bulkDeleteBtn">
                                        <i class="bi bi-trash me-1"></i>
                                        Elimina Selezionati
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-hover admin-table mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   id="selectAll"
                                                   title="Seleziona tutti">
                                        </th>
                                        <th style="width: 80px;">Immagine</th>
                                        <th>Titolo</th>
                                        <th style="width: 150px;">Fonte</th>
                                        <th style="width: 110px;">Stato</th>
                                        <th style="width: 140px;">Data</th>
                                        <th style="width: 180px;" class="text-end">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="post : ${posts}">
                                        <td>
                                            <input type="checkbox" 
                                                   class="form-check-input post-checkbox" 
                                                   th:value="${post.id}"
                                                   th:id="'post-' + ${post.id}">
                                        </td>
                                        <td>
                                            <div class="post-thumbnail">
                                                <img th:if="${post.hasImage()}" 
                                                     th:src="${post.imageUrl}" 
                                                     th:alt="${post.title}"
                                                     class="img-thumbnail">
                                                <div th:unless="${post.hasImage()}" 
                                                     class="thumbnail-placeholder">
                                                    <i class="bi bi-image"></i>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="post-info">
                                                <a th:href="@{/admin/blog/edit/{id}(id=${post.id})}" 
                                                   class="post-title fw-semibold text-dark text-decoration-none"
                                                   th:text="${post.title}">
                                                    Titolo del Post
                                                </a>
                                                <div class="post-excerpt text-muted small mt-1" 
                                                     th:text="${post.getExcerpt(80)}">
                                                    Estratto del contenuto...
                                                </div>
                                                <div class="post-meta text-muted small mt-1">
                                                    <i class="bi bi-link-45deg me-1" th:if="${post.hasExternalLink()}"></i>
                                                    <span th:if="${post.hasExternalLink()}" title="Ha link esterno">
                                                        Link esterno
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:if="${post.sourceName}" 
                                                  class="badge bg-secondary rounded-pill"
                                                  th:text="${post.sourceName}">
                                                Fonte
                                            </span>
                                            <span th:unless="${post.sourceName}" 
                                                  class="text-muted small">
                                                -
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill" 
                                                  th:classappend="${post.published} ? 'bg-success' : 'bg-warning text-dark'">
                                                <i th:class="${post.published} ? 'bi bi-check-circle me-1' : 'bi bi-pencil me-1'"></i>
                                                <span th:text="${post.published} ? 'Pubblicato' : 'Bozza'">Stato</span>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-muted small">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                <span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy')}">Data</span>
                                            </div>
                                            <div class="text-muted small">
                                                <i class="bi bi-clock me-1"></i>
                                                <span th:text="${#temporals.format(post.createdAt, 'HH:mm')}">Ora</span>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- Edit -->
                                                <a th:href="@{/admin/blog/edit/{id}(id=${post.id})}" 
                                                   class="btn btn-outline-primary"
                                                   title="Modifica">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                
                                                <!-- Preview -->
                                                <a th:href="@{/admin/blog/preview/{id}(id=${post.id})}" 
                                                   class="btn btn-outline-info"
                                                   target="_blank"
                                                   title="Anteprima">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                
                                                <!-- Toggle Publish -->
                                                <form th:action="@{/admin/blog/toggle-publish/{id}(id=${post.id})}" 
                                                      method="post" 
                                                      class="d-inline"
                                                      th:id="'toggleForm-' + ${post.id}">
                                                    <button type="submit" 
                                                            class="btn"
                                                            th:classappend="${post.published} ? 'btn-outline-warning' : 'btn-outline-success'"
                                                            th:title="${post.published} ? 'Rimuovi pubblicazione' : 'Pubblica'">
                                                        <i th:class="${post.published} ? 'bi bi-eye-slash' : 'bi bi-check-circle'"></i>
                                                    </button>
                                                </form>
                                                
                                                <!-- Delete -->
                                                <button type="button" 
                                                        class="btn btn-outline-danger"
                                                        th:onclick="'confirmDelete(' + ${post.id} + ', \'' + ${post.title} + '\')'"
                                                        title="Elimina">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Table Footer -->
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">
                                    Mostrando 
                                    <strong th:text="${posts.size()}">0</strong> di 
                                    <strong th:text="${totalItems}">0</strong> post
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav th:if="${totalPages > 1}" class="mt-4" aria-label="Paginazione">
                    <ul class="pagination justify-content-center">
                        <!-- Previous -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" 
                               th:href="@{/admin/blog(page=${currentPage - 1}, status=${status}, search=${search})}"
                               aria-label="Precedente">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>

                        <!-- First Page -->
                        <li class="page-item" th:if="${currentPage > 2}">
                            <a class="page-link" 
                               th:href="@{/admin/blog(page=0, status=${status}, search=${search})}">
                                1
                            </a>
                        </li>

                        <!-- Dots -->
                        <li class="page-item disabled" th:if="${currentPage > 3}">
                            <span class="page-link">...</span>
                        </li>

                        <!-- Page Numbers -->
                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:if="${i >= currentPage - 2 && i <= currentPage + 2}"
                            class="page-item"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link" 
                               th:href="@{/admin/blog(page=${i}, status=${status}, search=${search})}"
                               th:text="${i + 1}">1</a>
                        </li>

                        <!-- Dots -->
                        <li class="page-item disabled" th:if="${currentPage < totalPages - 4}">
                            <span class="page-link">...</span>
                        </li>

                        <!-- Last Page -->
                        <li class="page-item" th:if="${currentPage < totalPages - 3}">
                            <a class="page-link" 
                               th:href="@{/admin/blog(page=${totalPages - 1}, status=${status}, search=${search})}"
                               th:text="${totalPages}">
                                10
                            </a>
                        </li>

                        <!-- Next -->
                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                            <a class="page-link" 
                               th:href="@{/admin/blog(page=${currentPage + 1}, status=${status}, search=${search})}"
                               aria-label="Successivo">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

            </div>
        </div>
    </main>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Sei sicuro di voler eliminare questo post?</p>
                <p class="mb-0"><strong id="deletePostTitle"></strong></p>
                <div class="alert alert-warning mt-3 mb-0">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        Questa azione non può essere annullata.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    Annulla
                </button>
                <form id="deleteForm" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Elimina Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="bulkDeleteModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Elimina Post Selezionati
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Sei sicuro di voler eliminare <strong id="bulkDeleteCount">0</strong> post selezionati?</p>
                <div class="alert alert-warning mb-0">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        Questa azione non può essere annullata.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    Annulla
                </button>
                <form th:action="@{/admin/blog/delete-multiple}" method="post" id="bulkDeleteForm">
                    <input type="hidden" name="postIds" id="bulkDeleteIds">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Elimina Tutti
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const postCheckboxes = document.querySelectorAll('.post-checkbox');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountSpan = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkDeleteModal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Select All functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            postCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });
    }

    // Individual checkbox change
    postCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllState();
            updateBulkActions();
        });
    });

    function updateSelectAllState() {
        const allChecked = Array.from(postCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(postCheckboxes).some(cb => cb.checked);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }

    function updateBulkActions() {
        const selectedCount = Array.from(postCheckboxes).filter(cb => cb.checked).length;
        
        if (selectedCount > 0) {
            bulkActionsBar.style.display = 'block';
            selectedCountSpan.textContent = selectedCount;
        } else {
            bulkActionsBar.style.display = 'none';
        }
    }

    // Bulk delete
    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', function() {
            const selectedIds = Array.from(postCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selectedIds.length > 0) {
                document.getElementById('bulkDeleteCount').textContent = selectedIds.length;
                document.getElementById('bulkDeleteIds').value = selectedIds.join(',');
                bulkDeleteModal.show();
            }
        });
    }

    // Single delete confirmation
    window.confirmDelete = function(postId, postTitle) {
        document.getElementById('deletePostTitle').textContent = postTitle;
        document.getElementById('deleteForm').action = '/admin/blog/delete/' + postId;
        deleteModal.show();
    };

    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert:not(.alert-warning)');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
});
</script>

</body>
</html>